// main global script file

//=============================================================================
// INITIALIZATION
//=============================================================================

// set default game options
function set_default_options()
{
  System.Volume = 100;
  sldAudio.Value = System.Volume;
  sldSpeed.Value = 40;
  SetGameSpeed(40);

  if (IsSpeechVoxAvailable())
  {
     Speech.VoiceMode = eSpeechVoiceAndText;
     btnVoice.Text = "Voice and Text";
     sldVoice.Value = 255;
     SetSpeechVolume(255);
  }

  if (System.SupportsGammaControl)
  {
    System.Gamma = 100;
    sldGamma.Value = 100;
  }
}

// initialize gPanel
function initialize_control_panel()
{
  if (!IsSpeechVoxAvailable())
  {
    // hide the speech controls, if speech is not available
    lblVoice.Visible = false;
    btnVoice.Visible = false;
    sldVoice.Visible = false;
  }

  if (!System.SupportsGammaControl) {
    // hide the gamma control, if not supported
    sldGamma.Visible = false;
    lblGamma.Visible = false;
  }

  set_default_options();
}

// called when the game starts, before the first room is loaded
function game_start()
{
  // initialize gPanel controls
  initialize_control_panel();

  // set KeyboardMovement movement mode
  KeyboardMovement.Mode = eKeyboardMovementModeTapping;

  // set KeyboardMovement keys
  //KeyboardMovement.KeyUp = eKeyW;
  //KeyboardMovement.KeyDown = eKeyS;
  //KeyboardMovement.KeyLeft = eKeyA;
  //KeyboardMovement.KeyRight = eKeyD;

  // Auto-save on the save slot 999
  SetRestartPoint();
}

//=============================================================================
// Scripts
//=============================================================================

function SayTypewriterStyle(Character* sayingcharacter, String message, int delay)
{
    int length = message.Length;
    String partialMessage;
    Overlay* overlay = null;

    for (int i = 0; i < length; i++) {
        partialMessage = message.Substring(0, i + 1);
        
        // Remove the old overlay, if it exists
        if (overlay != null) {
            overlay.Remove();
        }
        
        // Create a new overlay with the updated text (x, y, width, eFontSpeech, fontColor, "Your Text Here")
        overlay = Overlay.CreateTextual(sayingcharacter.x, sayingcharacter.y - 200, 200, eFontNormal, 16, partialMessage);
        
        Wait(delay); // Delay between each letter
    }
    
    Wait(200);  // Optional pause to display the completed text
    if (overlay != null) {
        overlay.Remove(); // Clean up after displaying the full text
    }
}

//=============================================================================
// Common GUI functions
//=============================================================================

// hide the icon bar and show a GUI
function open_gui(GUI* gui_to_open)
{
  if (gui_to_open != gInventory)
  {
    lblOverHotspot.Visible = false;
  }

  gIconbar.Visible = false;
  mouse.UseModeGraphic(eModePointer);
  gui_to_open.Visible = true;
}

// hide the GUI and show the icon bar
function close_gui(GUI* gui_to_close)
{
  gui_to_close.Visible = false;
  mouse.UseDefaultGraphic();
  lblOverHotspot.Visible = true;
  gIconbar.Visible = true;
}

// hide a GUI, based on a GUI control
function close_owning_gui(GUIControl* control)
{
  close_gui(control.OwningGUI);
}

// hide a GUI directly from an OnClick event
function close_gui_onclick(GUIControl *control, MouseButton button)
{
  if (control.OwningGUI==gInventory)
  {
    close_owning_gui(control);
    open_gui(gChestOpen05);
    Wait(WaitGUI);
    close_gui(gChestOpen05);
    open_gui(gChestOpen04);
    Wait(WaitGUI);
    close_gui(gChestOpen04);
    open_gui(gChestOpen03);
    Wait(WaitGUI);
    close_gui(gChestOpen03);
    open_gui(gChestOpen02);
    Wait(WaitGUI);
    close_gui(gChestOpen02);
    open_gui(gChestOpen01);
    Wait(WaitGUI);
    close_gui(gChestOpen01);
  }
  else
  {
    close_owning_gui(control);
  }
}

function show_inventory_window()
{
  mouse.Mode = eModeInteract;
  open_gui(gInventory);
}

function show_save_game_dialog()
{
  // get the list of save games
  lstSaveGamesList.FillSaveGameList();

  if (lstSaveGamesList.ItemCount > 0)
  {
    // if there is at least one, set the default text
    // to be the first game's name
    txtNewSaveName.Text = lstSaveGamesList.Items[0];
  }
  else
  {
    // no save games yet, so default to empty text
    txtNewSaveName.Text = "";
  }

  open_gui(gSaveGame);
}

function show_restore_game_dialog()
{
  lstRestoreGamesList.FillSaveGameList();
  open_gui(gRestoreGame);
}

//=============================================================================
// ICONBAR
//=============================================================================

function btnIconSave_Click(GUIControl *control, MouseButton button)
{
  show_save_game_dialog();
}

function btnIconLoad_Click(GUIControl *control, MouseButton button)
{
  show_restore_game_dialog();
}

function btnIconPanel_Click(GUIControl *control, MouseButton button)
{
  open_gui(gPanel);
}

function btnIconExit_Click(GUIControl *control, MouseButton button)
{
  open_gui(gExitGame);
}

//=============================================================================
// INVENTORY WINDOW
//=============================================================================

function btnInvUp_Click(GUIControl *control, MouseButton button)
{
  invCustom.ScrollUp();
}

function btnInvDown_Click(GUIControl *control, MouseButton button)
{
  invCustom.ScrollDown();
}

function btnInvSelect_Click(GUIControl *control, MouseButton button)
{
  // switch to the interact cursor
  mouse.Mode = eModeInteract;
  // ...but override the appearance to look like the arrow
  mouse.UseModeGraphic(eModePointer);
}

function btnIconInv_Click(GUIControl *control, MouseButton button)
{
  open_gui(gChestOpen01);
  Wait(WaitGUI);
  close_gui(gChestOpen01);
  open_gui(gChestOpen02);
  Wait(WaitGUI);
  close_gui(gChestOpen02);
  open_gui(gChestOpen03);
  Wait(WaitGUI);
  close_gui(gChestOpen03);
  open_gui(gChestOpen04);
  Wait(WaitGUI);
  close_gui(gChestOpen04);
  open_gui(gChestOpen05);
  Wait(WaitGUI);
  close_gui(gChestOpen05);
  show_inventory_window();
}

function btnIconCurInv_Click(GUIControl *control, MouseButton button)
{
  if (player.ActiveInventory != null)
  {
    mouse.Mode = eModeUseinv;
  }
}

//=============================================================================
// CONTROL PANEL
//=============================================================================

function btnSave_OnClick(GUIControl *control, MouseButton button)
{
  close_owning_gui(control);
  Wait(1);
  btnIconSave_Click(btnIconSave, eMouseLeft);
}

function btnAbout_OnClick(GUIControl *control, MouseButton button)
{
  Display("%s\nAGS %s", Game.Name, System.Version);
}

function btnQuit_OnClick(GUIControl *control, MouseButton button)
{
  close_owning_gui(control);
  open_gui(gExitGame);
}

function btnLoad_OnClick(GUIControl *control, MouseButton button)
{
  close_owning_gui(control);
  Wait(1);
  btnIconLoad_Click(btnIconLoad, eMouseLeft);
}

function sldAudio_OnChange(GUIControl *control)
{
  System.Volume = sldAudio.Value;
}

function sldVoice_OnChange(GUIControl *control)
{
  SetSpeechVolume(sldVoice.Value);
}

function btnVoice_OnClick(GUIControl *control, MouseButton button)
{
  if (Speech.VoiceMode == eSpeechVoiceAndText)
  {
    Speech.VoiceMode = eSpeechVoiceOnly;
    btnVoice.Text = "Voice only";
  }
  else if (Speech.VoiceMode == eSpeechVoiceOnly)
  {
    Speech.VoiceMode = eSpeechTextOnly;
    btnVoice.Text = "Text only";
  }
  else if (Speech.VoiceMode == eSpeechTextOnly)
  {
    Speech.VoiceMode = eSpeechVoiceAndText;
    btnVoice.Text = "Voice and Text";
  }
}

function sldGamma_OnChange(GUIControl *control)
{
  System.Gamma = sldGamma.Value;
}

function btnDefault_OnClick(GUIControl *control, MouseButton button)
{
  set_default_options();
}

function sldSpeed_OnChange(GUIControl *control)
{
  SetGameSpeed(sldSpeed.Value);
}

//=============================================================================
// SAVE / LOAD DIALOGS
//=============================================================================

int find_save_slot(String name)
{
  bool slots[] = new bool[999];
  int slots_used = 0;

  // record which slots are occupied already, 
  // if the types save name matches any existing one, then use that
  for (int i = 0; i < lstSaveGamesList.ItemCount; i++)
  {
    if (lstSaveGamesList.Items[i] == name)
    {
      // found existing save with matching name
      return lstSaveGamesList.SaveGameSlots[i];
    }

    // remember which slots are already taken
    slots[lstSaveGamesList.SaveGameSlots[i]] = true;
    slots_used++;
  }
  
  // current version of AGS has a limit of 50 save slots
  // that may be displayed in the ListBox at the same time
  if (slots_used >= 50)
  {
    return -1;
  }

  // find first free save slot, starting with slot 1 (for "cosmetic" purposes)
  for (int i = 1; i < 999; i++)
  {
    if (!slots[i])
    {
      return i;
    }
  }

  // no free slots found
  return -1;
}

function btnSaveGame_OnClick(GUIControl *control, MouseButton button)
{
  int gameSlotToSaveInto = find_save_slot(txtNewSaveName.Text);

  if (gameSlotToSaveInto < 0)
  {
    Display("Save slots limit of 50 is reached, delete some of the existing saves first!");
  }
  else
  {
    SaveGameSlot(gameSlotToSaveInto, txtNewSaveName.Text);
    close_owning_gui(control);
  }
}

function btnRestoreGame_OnClick(GUIControl *control, MouseButton button)
{
  if (lstRestoreGamesList.SelectedIndex >= 0)
  {
    RestoreGameSlot(lstRestoreGamesList.SaveGameSlots[lstRestoreGamesList.SelectedIndex]);
  }

  close_owning_gui(control);
}

function lstSaveGamesList_OnSelectionCh(GUIControl *control)
{
  txtNewSaveName.Text = lstSaveGamesList.Items[lstSaveGamesList.SelectedIndex];
}

function txtNewSaveName_OnActivate(GUIControl *control)
{
  // pressing Return in the text box simulates clicking the save button
  btnSaveGame_OnClick(control, eMouseLeft);
}

function btnDeleteSave_OnClick(GUIControl *control, MouseButton button)
{
  if (lstSaveGamesList.SelectedIndex >= 0)
  {
    DeleteSaveSlot(lstSaveGamesList.SaveGameSlots[lstSaveGamesList.SelectedIndex]);
    lstSaveGamesList.FillSaveGameList();
  }
}

//=============================================================================
// RESTART DIALOG
//=============================================================================

function btnRestart_OnClick(GUIControl *control, MouseButton button)
{
  close_owning_gui(control);
  open_gui(gRestart);
}

function btnRestartYes_OnClick(GUIControl *control, MouseButton button)
{
  RestartGame();
}

//=============================================================================
// QUIT DIALOG
//=============================================================================

function btnConfirmedQuit_OnClick(GUIControl *control, MouseButton button)
{
  QuitGame(0);
}

//=============================================================================
// PLAYER INPUT
//=============================================================================

// called when a key is pressed
function on_key_press(eKeyCode keycode, int mod)
{
  // check for Escape first, so it can be used on GUIs that pause the game
  if (keycode == eKeyEscape)
  {
    if (gInventory.Visible)
    {
      // Escape will close the restore game dialog
      close_gui(gInventory);
    }
    else if (gPanel.Visible)
    {
      // Escape will turn the panel off
      close_gui(gPanel);
    }
    else if (gSaveGame.Visible)
    {
      // Escape will close the save game dialog
      close_gui(gSaveGame);
    }
    else if (gRestoreGame.Visible)
    {
      // Escape will close the restore game dialog
      close_gui(gRestoreGame);
    }
    if (gRestart.Visible)
    {
      // Escape will cancel a restart
      close_gui(gRestart);
    }
    else if (gExitGame.Visible)
    {
      // Escape will cancel exiting the game
      close_gui(gExitGame);
    }
    else
    {
      // Escape will turn the panel on
      open_gui(gPanel);
    }
  }
  else if (IsGamePaused() || !IsInterfaceEnabled())
  {
    // game paused, so don't react to any keypresses
    keycode = 0;
  }
  else if (keycode == eKeyQ && (mod & eKeyModCtrl))
  {
    // Ctrl-Q will quit the game
    open_gui(gExitGame);
  }
  else if (keycode == eKeyF5)
  {
    // F5 will prompt to save a game
    show_save_game_dialog();
  }
  else if (keycode == eKeyF7)
  {
    // F7 will prompt to save a game
    show_restore_game_dialog();
  }
  else if (keycode == eKeyF9)
  {
    // F9 will prompt to restart the game
    open_gui(gRestart);
  }
  else if (keycode == eKeyF12)
  {
    // F12 will save a screenshot to the save game folder
    SaveScreenShot("screenshot.pcx");
  }
  else if (keycode == eKeyReturn)
  {
    if (gRestart.Visible)
    {
      // Enter confirms a restart
      RestartGame();
    }
  }
  else if (keycode == eKeyTab)
  {
    // Tab opens the inventory
    show_inventory_window();
  }
  else if (mod & eKeyModCtrl)
  {
    if (keycode == eKeyS)
    {
      // Ctrl-S will give the player all defined inventory items
      Debug(0, 0);
    }
    else if (keycode == eKeyV)
    {
      // Ctrl-V will show game engine version and build date
      Debug(1, 0);
    }
    else if (keycode == eKeyA)
    {
      // Ctrl-A will show walkable areas
      Debug(2, 3);
    }
    else if (keycode == eKeyX)
    {
      // Ctrl-X will let the player teleport to any room
      Debug(3, 0);
    }
  }
}

function handle_room_click(MouseButton button)
{
  if (button == eMouseLeft)
  {
    // left-click, so try using the current mouse cursor mode at this position
    Room.ProcessClick(mouse.x, mouse.y, mouse.Mode );
  }
  else if (button == eMouseRight || button == eMouseWheelSouth){
    // right-click or mouse wheel down will cycle the mouse cursor mode forwards
    mouse.SelectNextMode();
  }
  else if (button == eMouseMiddle)
  {
    // middle-click makes the character walk to clicked area, regardless of cursor mode
    Room.ProcessClick(mouse.x, mouse.y, eModeWalkto);
  }
  else if (button == eMouseWheelNorth)
  {
    // mouse wheel up will cycle the cursor mode backwards
    mouse.SelectPreviousMode();
  }
}

function handle_inventory_click(MouseButton button)
{
  // InventoryItem.GetAtScreenXY could return null here
  // so using game.inv_activated instead is a safer option
  InventoryItem* item = inventory[game.inv_activated];
  
  if (button == eMouseLeftInv)
  {
    if (mouse.Mode == eModeInteract)
    {
      // interact mode selects an inventory item
      player.ActiveInventory = item;
    }
    else if (mouse.Mode == eModeUseinv)
    {
      if (item.ID != player.ActiveInventory.ID)
      {
        // use one item on another
        item.RunInteraction(eModeUseinv);
      }
    }
    else
    {
      // otherwise run corresponding interaction (LookAt, etc)
      item.RunInteraction(mouse.Mode);
    }
  }
  else
  {
    // right click is always "Look At"
    item.RunInteraction(eModeLookat);
  }
}

// called when a mouse button is clicked
function on_mouse_click(MouseButton button)
{
  if (button == eMouseLeftInv || button == eMouseRightInv || button == eMouseMiddleInv)
  {
    handle_inventory_click(button);
  }
  // game is paused, then don't process mouse clicks inside the room
  else if (!IsGamePaused())
  {
    handle_room_click(button);
  }
}

//=============================================================================
// GAME EVENTS
//=============================================================================

// called on every game cycle, except when the game is blocked
function repeatedly_execute()
{
  if (cMonty.View==2 && cMonty.Animating==false)
  {
    //cMonty.LockView(39);
  }
  //else cMonty.LockView(2);
  
 if (cMonty.View==4 && cMonty.Loop==0 && (cMonty.Frame==2 || cMonty.Frame==4 || cMonty.Frame == 6))
 {
   //Display("hi");
   aScoop_mixdown.Play();
 }
 //if (cMonty.View==2 && cMonty.Frame==3)
 //{
 //  aWalk.Play();
 //}
}

// called on every game cycle, even when the game is blocked
function repeatedly_execute_always()
{
  if (cMonty.View==2 && cMonty.Frame==3)
 {
   aWalk.Play();
 }
}

// Called when a dialog script line "run-script" is processed
function dialog_request(int param)
{
  if (param == 1)
  {
    cHuman01.LockView(12);
    cHuman01.Walk(1110, 689, eBlock);
    cHuman01.LockView(3);
    Puzzle01Stage = 1;
  }
}

// called when processclick wasn't handled anywhere else
function unhandled_event (int what, int type)
{
  if (what == 1) // Unhandled events for HOTSPOTS
  {
    if (type == 1) // look
    {
      player.Say("I see nothing special about it.");
    }
    else if (type == 2) // interact
    {
      player.Say("I can't do anything with it.");
    }
    else if (type == 3) // use inv on
    {
      player.Say("That won't do anything.");
    }
    else if (type == 4) // talk to
    {
      player.Say("I don't think it's going to talk back.");
    }
    else if (type == 7) // pick up
    {
      player.Say("I'm not sure I should be taking it.");
    }
  }
  else if (what == 2) // Unhandled events for OBJECTS
  {
    if (type == 0) // look
    {
      player.Say("Looks alright.");
    }
    else if (type == 1) // interact
    {
      player.Say("I'm not sure how to use it.");
    }
    else if (type == 2) // talk to
    {
      player.Say("I don't think it's going to answer me.");
    }
    else if (type == 3) // use inv on
    {
      player.Say("That's a funny idea.");
    }
    else if (type == 5) // pick up
    {
      player.Say("I don't want to have it.");
    }
  }
  else if (what == 3) // Unhandled events for CHARACTERS
  {
    if (type == 0) // look
    {
      player.Say("Hm.");
    }
    else if (type == 1) // interact
    {
      player.Say("Eh?");
    }
    else if (type == 2) // talk to
    {
      player.Say("Got nothing to say.");
    }
    else if (type == 3) // use inv on
    {
      player.Say("I don't think I should give that away.");
    }
    else if (type == 5) // pick up
    {
      player.Say("I'm not sure they would be compliant.");
    }
  }
  else if (what == 5) // Unhandled events for INVENTORY ITEMS
  {
    if (type == 0) // look
    {
      player.Say("It's just some junk in my inventory.");
    }
    else if (type == 1) // interact
    {
      player.Say("Er, no?");
    }
    else if (type == 3) // use inv on
    {
      player.Say("That's ridiculous.");
    }
  }
}

//=============================================================================
// Global interactions: Characters, Inventory items, ...
//=============================================================================

function CraftItems(int craftingtype)
{
  gCraftAnimGUI.SetPosition(mouse.x, mouse.y);
  gCraftAnimGUI.Visible = true;
  if (craftingtype ==1)
  {
    cMonty.LoseInventory(iHeliumTank);
    cMonty.LoseInventory(iEyes);
    gCraftAnimGUI.BackgroundGraphic=165;
    Wait(WaitGUIAnim);
    gCraftAnimGUI.BackgroundGraphic=166;
    Wait(WaitGUIAnim);
    gCraftAnimGUI.BackgroundGraphic=167;
    Wait(WaitGUIAnim);
    gCraftAnimGUI.BackgroundGraphic=168;
    Wait(WaitGUIAnim);
    gCraftAnimGUI.BackgroundGraphic=169;
    Wait(WaitGUIAnim);
    gCraftAnimGUI.BackgroundGraphic=170;
    Wait(WaitGUIAnim);
    gCraftAnimGUI.BackgroundGraphic=171;
    Wait(WaitGUIAnim);
    gCraftAnimGUI.BackgroundGraphic=172;
    Wait(WaitGUIAnim);
    gCraftAnimGUI.BackgroundGraphic=173;
    Wait(WaitGUIAnim);
    gCraftAnimGUI.BackgroundGraphic=174;
    Wait(WaitGUIAnim);
    gCraftAnimGUI.BackgroundGraphic=175;
    Wait(WaitGUIAnim);
    gCraftAnimGUI.BackgroundGraphic=176;
    Wait(WaitGUIAnim);
    cMonty.AddInventory(iEyeBalloons);
    cMonty.LoseInventory(iHeliumTank);
    cMonty.LoseInventory(iEyes);
    gCraftAnimGUI.Visible=false;
    Mouse.Mode=2;
  }
}


function cEgo_Look(Character *thisCharacter, CursorMode mode)
{
  Display("Damn, I'm looking good!");
}

function cEgo_Interact(Character *thisCharacter, CursorMode mode)
{
  Display("You rub your hands up and down your clothes.");
}

function cEgo_Talk(Character *thisCharacter, CursorMode mode)
{
  Display("Talking to yourself is a sign of madness!");
}

function gInventory_OnClick(GUI *theGui, MouseButton button)
{

}

function RandomBoxThink()
{
  int randobox = Random(5);
  if (randobox==0)
  {
    cMonty.Think("I wonder if my tools are in here");
  }
  else if (randobox==1)
  {
    cMonty.Think("I hope there's not a demon in any of these");
  }
  else if (randobox==2)
  {
    cMonty.Think("what a 'smashing' looking box");
  }
  else if (randobox==3)
  {
    cMonty.Think("shall I open it... or BURN it?");
  }
    else if (randobox==4)
  {
    cMonty.Think("eeny, meeny, miney, moe...");
  }
  else if (randobox==2)
  {
    cMonty.Think("which box has the dynamite, which box has the saw?");
  }
}

function WalkToObjectAndPickupTall(Object *obj)
{
  // Move player to the object's location
  cMonty.Walk(obj.X, obj.Y, eBlock);  // Use eBlock to wait until the player reaches the destination
  cMonty.LockView(43);
  cMonty.Animate(0, 3, eOnce, eBlock);
  aPickup.Play();
  obj.X=-200;
  cMonty.Animate(1, 3, eOnce, eBlock);
  cMonty.LockView(2);
}

function WalkToObjectAndPickup(Object *obj)
{
    // Move player to the object's location
    cMonty.Walk(obj.X, obj.Y, eBlock);  // Use eBlock to wait until the player reaches the destination
    cMonty.LockView(20);
    cMonty.Animate(0, 3, eOnce, eBlock);
    aPickup.Play();
    if (DevilSkeleton==true)
    {
      DevilSkeleton=false;
      RunDevilDust=true;
      cMonty.Animate(1, 3, eOnce, eBlock);
      cMonty.LockView(2);
    }
    else
    {
    obj.X=-200;
    cMonty.Animate(1, 3, eOnce, eBlock);
    cMonty.LockView(2);
    }
 }
 
 function GoToObjectAndPickup(Object *pickup)
 {
   cMonty.Walk(pickup.X, pickup.Y, eBlock);
   pickup.Visible=false;
   numPresents++;
   String message = String.Format("You have: %d Presents", numPresents);
   cMonty.Say(message);
 }

function cHuman01_UseInv(Character *theCharacter, CursorMode mode)
{
  if (player.ActiveInventory.ID == 6) //spoon!
    if (Puzzle01Stage==1) //makes sure that you can't gouge his eyes till he's inside.
    {
      cMonty.Walk((theCharacter.x-70),  theCharacter.y+10, eBlock);
      cMonty.LockView(4);
      aScoop_mixdown.Play();
      cMonty.Animate(0, 7, eOnce, eBlock);
      //Wait(50);
      EyeballAnim=true; //eyeball animation triggers room 3's "on tick".
      cHuman01.LockView(16);
      cHuman01.SetWalkSpeed(5, 5);
      cHuman01.Walk(928, 528, eNoBlock);
      //cHuman01.Animate(0, 10, eRepeat, eNoBlock);
      cMonty.UnlockView();
      //cMonty.AddInventory(iEyes);
      cMonty.LoseInventory(iSpoon);
      Puzzle01Stage = 2;
      Display("I can grab the Helium and he won't even know...");
    }
    else
    {
      cHuman01.Say("Hey invite a guy inside first...");
    }
  
  else if (player.ActiveInventory.ID == 8) // SAW!
  {
    if (cHuman01.View == 16)
    {
      cHuman01.StopMoving();
      HeadRoll=true;
      cMonty.Walk(theCharacter.x-70,  theCharacter.y+10, eBlock);
      cMonty.LockView(4);
      aSaw.Play();
      cMonty.Animate(1, 5, eOnce, eBlock);
      cHuman01.LockView(18);
      cHuman01.Animate(0, 2, eRepeat, eNoBlock);
      cMonty.UnlockView();
      cMonty.LoseInventory(iSaw);
      Puzzle01Stage = 5;
    }
    else if (cHuman01.View == 3)
    {
      player.Say("Not yet... I think I need to harvest some balloon-shaped things.");
    }
    
  }
    else if (player.ActiveInventory.ID == 11) //DynaMITE!
  {
    if (cHuman01.View == 18)
    {
      cMonty.Walk(theCharacter.x-70,  theCharacter.y+10, eBlock);
      cHuman01.LockView(8);
      aExplode_Long.Play();
      cHuman01.Animate(0, 5, eOnce, eBlock);
      cMonty.UnlockView();
      cMonty.LoseInventory(iDynamite);
      theCharacter.SetTextProperty("Description", "Pickup");
      Puzzle01Stage = 6;
    }
    else
    {
      player.Say("Not yet. Patience, my little monster.");
    }
    
  }
}
function cHuman01_Interact(Character *theCharacter, CursorMode mode)
{
  if (theCharacter.View == 8)
  {
    cMonty.Walk((cHuman01.x-70),  cHuman01.y+10, eBlock);
    cHuman01.LockView(9);
    Puzzle01Stage=7;
    cMonty.AddInventory(iIntestine);
    cHuman01.SetWalkSpeed(50, 50);
    cHuman01.Walk(257, 546, eBlock, eAnywhere);
  }
  else if (theCharacter.View == 9)
    {
    cMonty.Walk((cHuman01.x-70),  cHuman01.y+10, eBlock);
    cHuman01.ChangeRoom(0);
    cMonty.AddInventory(iLegs);
  }
}

function iEyes_UseInv(InventoryItem *theItem, CursorMode mode)
{
  if (player.ActiveInventory == iHeliumTank)
  {
    aBalloonpump02.Play();
    CraftItems(1);
  }
}

function iMeatGrinder_UseInv(InventoryItem *theItem, CursorMode mode)
{
if (player.ActiveInventory == iLegs)
  {
    cMonty.AddInventory(iSludge);
    cMonty.LoseInventory(iLegs);
    cMonty.LoseInventory(iMeatGrinder);
  }
}

function cHuman01_Talk(Character *theCharacter, CursorMode mode)
{
 if (DoorUp==false)
 {
   cHuman01.Say("Open the door, One-Eyes.");
 }
 else
 {
  if (Puzzle01Stage == 0)
  {
    dHelSeller01.Start();
  }
  else if (Puzzle01Stage == 1)
  {
    dHelSeller02.Start();
  }
 }
}

function iBread_UseInv(InventoryItem *theItem, CursorMode mode)
{
if (player.ActiveInventory == iSludge)
  {
    cMonty.AddInventory(iBurgers);
    cMonty.LoseInventory(iBread);
    cMonty.LoseInventory(iSludge);
  }
}

function iHead_UseInv(InventoryItem *theItem, CursorMode mode)
{
if (player.ActiveInventory == iCandles)
  {
    cMonty.AddInventory(iHeadCandles);
    cMonty.LoseInventory(iCandles);
    cMonty.LoseInventory(iHead);
  }
}

function cHuman01_Look(Character *theCharacter, CursorMode mode)
{
player.Say("Ugh, another pesty no-good human trying to ruin my party.");
}

function iSpoon_Look(InventoryItem *theItem, CursorMode mode)
{
player.Say("Yup, a spoon is only good for SCOOPIN'...eyeballs");
}

function iEyes_Look(InventoryItem *theItem, CursorMode mode)
{
player.Say("What could I use these for? They're round, balloony shaped, ...");
}

function iSaw_Look(InventoryItem *theItem, CursorMode mode)
{
player.Say("You know what rusty saws are good for? NECKS!");
}

function iHead_Look(InventoryItem *theItem, CursorMode mode)
{
player.Say("Human heads. They're good for holding stuff. In their eye sockets.");
}

function iHeliumTank_Look(InventoryItem *theItem, CursorMode mode)
{
player.Say("We really need to conserve Helium for medical equipment...but just two more 'balloons' and then I'll stop.");
}

function iDynamite_Look(InventoryItem *theItem, CursorMode mode)
{
player.Say("Might have to blow somethiing (or some ONE) up.");
}

function iIntestine_Look(InventoryItem *theItem, CursorMode mode)
{
player.Say("Wow these intenstines are SO LONG... and pretty... I could hang them like art.");
}

function iMeatGrinder_Look(InventoryItem *theItem, CursorMode mode)
{
player.Say("Boy this meat grinder could gring ANYthing into juicy delicious meat");
}

function iLegs_Look(InventoryItem *theItem, CursorMode mode)
{
player.Say("There's human flesh inside these dungarees!");
}

function iSludge_Look(InventoryItem *theItem, CursorMode mode)
{
player.Say("You might not realize it but this is meat. To like, go with bread. For like, feeding my friends.");
}

function iBread_Look(InventoryItem *theItem, CursorMode mode)
{
player.Say("Pretend this bread looks like burger buns.");
}

function iCandles_Look(InventoryItem *theItem, CursorMode mode)
{
player.Say("Gotta jam these candles into something, but what?");
}

function btnIconWalk_OnClick(GUIControl *control, MouseButton button)
{
    Display("hi this is a thing");
    BackgroundMusic.Pause();
}

function Button2_OnClick(GUIControl *control, MouseButton button)
{
close_gui(gHelpGUI01);
open_gui(gHelpGUI02);
}

function Button6_OnClick(GUIControl *control, MouseButton button)
{
close_gui(gHelpGUI02);
cMonty.ChangeRoom(3, 350, 600, eDirectionRight);
}

function Button12_OnClick(GUIControl *control, MouseButton button)
{
close_gui(gHelpGUI02);
open_gui(gHelpGUI03);
}

function Button17_OnClick(GUIControl *control, MouseButton button)
{
close_gui(gHelpGUI03);
cMonty.ChangeRoom(3, 350, 600, eDirectionRight);
}

function iHeadCandles_UseInv(InventoryItem *theItem, CursorMode mode)
{
if (player.ActiveInventory==iTorch)
{
  player.LoseInventory(iTorch);
  player.LoseInventory(iHeadCandles);
  open_gui(gCraftAnimGUI);
  gCraftAnimGUI.BackgroundGraphic=296;
  Wait(WaitGUI*2);
  gCraftAnimGUI.BackgroundGraphic=297;
  Wait(WaitGUI*2);
  gCraftAnimGUI.BackgroundGraphic=298;
  Wait(WaitGUI*2);
  gCraftAnimGUI.BackgroundGraphic=299;
  Wait(WaitGUI*2);
  gCraftAnimGUI.BackgroundGraphic=300;
  Wait(WaitGUI*2);
  gCraftAnimGUI.BackgroundGraphic=301;
  Wait(WaitGUI*2);
  gCraftAnimGUI.BackgroundGraphic=302;
  Wait(WaitGUI*2);
  close_gui(gCraftAnimGUI);
  player.AddInventory(iSkullCandles);
}
}

function Button18_OnClick(GUIControl *control, MouseButton button)
{
close_gui(gHelpGUI01);
cMonty.ChangeRoom(3, 350, 600, eDirectionRight);
}

function iHeliumTank_UseInv(InventoryItem *theItem, CursorMode mode)
{
  if (player.ActiveInventory == iEyes)
  {
    aBalloonpump02.Play();
    CraftItems(1);
  }
}

function ButtonPlay_OnClick(GUIControl *control, MouseButton button)
{
close_gui(gStartScreen);
cMonty.ChangeRoom(2);
}

function Button20_OnClick(GUIControl *control, MouseButton button)
{
QuitGame(1);
}

function Button21_OnClick(GUIControl *control, MouseButton button)
{
  show_restore_game_dialog();
}

function Button24_OnClick(GUIControl *control, MouseButton button)
{
 if (musicChannel.IsPaused==true)
 {
  Button24.NormalGraphic=91;
  musicChannel.Resume();
 }
 else
 {
 Button24.NormalGraphic=90;
 musicChannel.Pause();
 }
}


function sldMusic_OnChange(GUIControl *control)
{
  musicChannel.Volume=sldMusic.Value;
}



function sldSFX_OnChange(GUIControl *control)
{
Game.SetAudioTypeVolume(eAudioTypeSound, sldSFX.Value, eVolExistingAndFuture);
Game.SetAudioTypeVolume(eAudioTypeAmbientSound, sldSFX.Value, eVolExistingAndFuture);
}
